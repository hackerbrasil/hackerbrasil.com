/*
 * Key navigator plugin for jQuery / Zepto.
 *
 * https://github.com/nekman/keynavigator
 */
(function(a,b){if(typeof exports==="object"){module.exports=b(require("jquery"))}else{if(typeof a.define==="function"&&a.define.amd){define(["jquery"],b)}else{b(a.jQuery||a.Zepto)}}}(this,function(d){var b={createFrom:function(g){var f=g.position();return{pos:{left:Math.round(f.left),top:Math.round(f.top)},$el:g}}};var c=function(f){this.table=this.buildTable(f);this.rows=this.buildRows();this.columns=this.buildColumns()};c.prototype={buildTable:function(f){return f.map(function(){return b.createFrom(d(this))})},buildColumns:function(){var g={},f=this;d.each(this.table,function(i,h){g[h.pos.left]=f.getColumnElements(h)});return g},buildRows:function(){var g={},f=this;d.each(this.table,function(j,h){g[h.pos.top]=f.getRowElements(h)});return g},getRowElements:function(f){var g=this;return d.map(this.table,function(h){if(g.isSameRow(h,f)){return h}return null})},getColumnElements:function(f){var g=this;return d.map(this.table,function(h){if(g.isSameColumn(h,f)){return h}return null})},getCurrent:function(g){var f=b.createFrom(g);return this.findPosition(this.getCell(f))},isSameColumn:function(f,g){if(!g){throw"cell"}return f.pos.left===g.pos.left},isSameRow:function(f,g){return f.pos.top===g.pos.top},isSame:function(f,g){return this.isSameColumn(f,g)&&this.isSameRow(f,g)},getCell:function(f){var g=this;return d.map(this.table,function(h){if(g.isSame(f,h)){return h}return null})[0]},findIndex:function(i,h){var g=0,f=i.length;for(;g<f;g++){if(h(i[g])){return g}}return g},findPosition:function(f){var h=this.getColumnElements(f),j=this.getRowElements(f),i=this.findIndex(h,function(k){return k.pos.top==f.pos.top}),g=this.findIndex(j,function(k){return k.pos.left==f.pos.left});return{colIndex:g,rowIndex:i}}};var a={0:"?",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause_break",20:"caps_lock",27:"escape",33:"page_up",34:"page_down",35:"end",36:"home",37:"left_arrow",38:"up_arrow",39:"right_arrow",40:"down_arrow",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"left_window_key",92:"right_window_key",93:"select_key",96:"numpad_0",97:"numpad_1",98:"numpad_2",99:"numpad_3",100:"numpad 4",101:"numpad_5",102:"numpad_6",103:"numpad_7",104:"numpad_8",105:"numpad_9",106:"multiply",107:"add",109:"subtract",110:"decimal point",111:"divide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"num_lock",145:"scroll_lock",186:";",187:"=",188:",",189:"dash",190:".",191:"/",192:"grave_accent",219:"open_bracket",220:"\\",221:"close_braket",222:"single_quote"};var e=function(h,g){var f=g||{};this.options=d.extend({},this.defaults,f);this.options.keys=d.extend({},this.defaults.keys,f.keys);this.$nodes=h;this.$parent=this.options.parent?d(this.options.parent):h.parent();if(this.options.removeOutline){this.$parent.css({outline:"none"})}if(!this.$parent.attr("tabindex")){this.$parent.attr({tabindex:this.options.tabindex||-1})}};e.keys=a;e.prototype={defaults:{useCache:true,cycle:true,activateOn:"click",parentFocusOn:"click",activeClass:"active",removeOutline:true,keys:{up_arrow:"up",down_arrow:"down",left_arrow:"left",right_arrow:"right"},onBeforeActive:d.noop,onAfterActive:d.noop},move:function(h){var g=h.cells[h.cellPosition],f=g[h.index];if(!f&&this.options.cycle){f=g[h.firstIndex?0:g.length-1]}if(!f){return}this.setActive(f.$el)},down:function(h,g){h.trigger("down",[h]);var f=this.cellTable.columns;this.move({cellPosition:b.createFrom(h).pos.left,index:g.rowIndex+1,cells:f,firstIndex:true})},up:function(h,g){h.trigger("up",[h]);var f=this.cellTable.columns;this.move({cellPosition:b.createFrom(h).pos.left,index:g.rowIndex-1,cells:f})},left:function(g,f){g.trigger("left",[g]);var h=this.cellTable.rows;this.move({cellPosition:b.createFrom(g).pos.top,index:f.colIndex-1,cells:h})},right:function(g,f){g.trigger("right",[g]);var h=this.cellTable.rows;this.move({cellPosition:b.createFrom(g).pos.top,index:f.colIndex+1,cells:h,firstIndex:true})},findCell:function(f){try{return this.cellTable.getCurrent(f)}catch(g){}this.reBuild();return this.cellTable.getCurrent(f)},handleKeyDown:function(j){var h=this.options.keys[e.keys[j.which]]||this.options.keys[j.which];if(!h){return}j.preventDefault?j.preventDefault():j.returnValue=false;if(!this.cellTable||!this.options.useCache){this.reBuild()}var g=this.$parent.find("."+this.options.activeClass);if(!g.length){g=this.$nodes.first()}if(!g.length){return}var f=this.findCell(g),i=this[h];if(i){return i.apply(this,[g,f,j])}h.apply(this,[g,f,j])},onBeforeActive:function(f){return this.options.onBeforeActive.apply(this,[f])},onAfterActive:function(f){return this.options.onAfterActive.apply(this,[f])},setActive:function(g){var f=this.onBeforeActive(g);if(f!==false){this.$nodes.removeClass(this.options.activeClass);g.addClass(this.options.activeClass)}this.onAfterActive(g)},reBuild:function(){var g=this.$parent,f=this;if(!this.options.useCache){this.$nodes=d(this.$nodes.selector)}g.off("keydown").off(this.options.parentFocusOn).on("keydown",d.proxy(this.handleKeyDown,this)).on(this.options.parentFocusOn,function(){g.focus()});var h=this.$nodes.filter(function(){return !d(this).attr("keynavigator-watched")});h.attr("keynavigator-watched",true).on(this.options.activateOn,function(){f.setActive(d(this))});this.cellTable=new c(this.$nodes)}};d.fn.keynavigator=function(g){var h=new e(this,g);var f;d(window).on("resize",function(){clearTimeout(f);f=setTimeout(function(){h.reBuild()},200)});h.reBuild();return d.extend(this,{keynavigator:h})};return d}));